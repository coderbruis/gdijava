---
typora-root-url: ..\..\图片
---

## 线程池

学习线程池之前，先要提出几个问题。

1. [什么是线程池？](#什么是线程池？)
2. [线程池有什么用？](#线程池有什么用？)
3. [线程池怎么使用？](#线程池怎么使用？)
4. [线程池的运行原理？](#线程池的运行原理？)
5. [使用线程池该注意些什么？](#线程池的使用注意事项)



### 1. 什么是线程池？

什么是线程池，并没有一个准确的定义。Java中的线程池是运用场景最多的并发框架，几乎所有需要异步或并发执行任务的程序都可以使用线程池。笼统的解释，就是用来合理管理创建的线程的一个“池子”，对于这个池，JDK提供了一套Executor框架，来帮助开发者有效的进行线程控制，也可以使用jdk为我们提供的一个ThreadPoolExecutor类，它实现了ExecutorService接口，代表着一个线程池，我们可以通过不同的构造方法参数来自定义的配置我们需要的**执行策略**。

### 2. 线程池有什么用？

#### 2.1 合理的使用线程池能够带来3个好处

- **降低资源损耗**

  通过重复利用已创建的线程降低线程创建和销毁造成的消耗。

- **提高响应速度**

  当任务到达时，任务可以不需要等到线程创建就能立即执行。

- **提高线程的可管理型**

  线程是稀缺资源，如果无限制地创建，不仅会消耗系统资源，还会降低系统的稳定性，使用线程池可以进行统一分配、调优和监控。但是，要做到合理利用线程池，必须对其实现原理了如指掌。





###3. 线程池怎么使用？

通常来说，会根据当前系统的CPU数量来设置线程大小，并且一个应用中共用一个线程池，便于管理，过多的线程因为调度切换的原因，反而不能提高系统资源的利用率。

？线程调用 阻塞队列 的take方法，如果当前阻塞队列中没有任务的话，线程将一直阻塞，如果有任务提交到线程池的话，会调用该阻塞队列的put方法，并且唤醒阻塞的线程来执行任务。



###4. 线程池的运行原理？

当向线程池提交一个任务之后，线程池是如何处理这个任务的呢？ 本节来看一下线程池
的主要处理流程。流程图如下：

![QQ截图20181103150240](/QQ截图20181103150240.png)

从图中可以看出，当提交一个新任务到线程池时，线程池的处理流程如下。
1）线程池判断核心线程池里的线程是否都在执行任务。如果不是，则创建一个新的工作
线程来执行任务。如果核心线程池里的线程都在执行任务，则进入下个流程。
2）线程池判断**工作队列**是否已经满。如果工作队列没有满，则将新提交的任务存储在这
个工作队列里。如果工作队列满了，则进入下个流程。
3）线程池判断线程池的线程是否都处于工作状态。如果没有，则创建一个新的工作线程
来执行任务。如果已经满了，则交给**饱和策略**来处理这个任务。

下面再来看看ThreadPoolExecutor的execute方法的示意图：

![QQ截图20181103150742](/QQ截图20181103150742.png)

ThreadPoolExecutor执行execute方法分下面4种情况。
1）如果当前运行的线程少于corePoolSize，则创建新线程来执行任务（注意，执行这一步骤
需要获取**全局锁**）。
2）如果运行的线程等于或多于corePoolSize，则将任务加入BlockingQueue。
3）如果无法将任务加入BlockingQueue（队列已满），则创建新的线程来处理任务（注意，执行这一步骤需要获取全局锁）。
4）如果创建新线程将使当前运行的线程超出maximumPoolSize，任务将被拒绝，并调用
RejectedExecutionHandler.rejectedExecution()方法。
ThreadPoolExecutor采取上述步骤的总体设计思路，是为了在执行execute()方法时，尽可能
地避免获取全局锁（那将会是一个严重的可伸缩瓶颈）。在ThreadPoolExecutor完成预热之后
（当前运行的线程数大于等于corePoolSize），几乎所有的execute()方法调用都是执行步骤2，而
步骤2不需要获取全局锁。



**工作线程**：线程池创建线程时，会将线程封装成工作线程Worker，Worker在执行完任务
后，还会循环获取工作队列里的任务来执行。我们可以从Worker类的run()方法里看到这点。 

在ThreadPoolExecutor中，线程的执行流程图：

![QQ截图20181103153029](/QQ截图20181103153029.png)

线程池中的线程执行任务分两种情况，如下。
1）在execute()方法中创建一个线程时，会让这个线程执行当前任务。
2）这个线程执行完上图中1的任务后，会反复从BlockingQueue获取任务来执行。 



### 5. 线程池的使用注意事项



### 6. 线程池中的执行策略

对于任务的执行方式有很多种。有并行执行任务的方式；也有串行执行任务的方式；有为每个任务创建一个对应的执行线程；也有创建固定数量的线程，然后重复调动这些线程来执行任务等等。这些执行方式就是任务的**执行策略**，每个执行策略都要规定很多任务的执行细节，比如用多少线程去执行任务；是在把线程都创建好之后再去处理任务，还是遇到任务之后再创建线程；创建好的线程在空闲的时候能不能销毁等等的问题，如果我们乐意，我们可以定义很多的执行策略。



## 参考资料

- Java并发编程的艺术

